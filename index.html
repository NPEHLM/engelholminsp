<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enkel Ljudinspelare</title>
    <style>
        /* Import a suitable font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');

        /* Basic styles for the body */
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #121212; /* Dark background */
            font-family: 'Inter', sans-serif;
            margin: 0;
            color: #e0e0e0;
        }

        /* Container for the application */
        .app-container {
            text-align: center;
            padding: 50px;
            border-radius: 25px;
            background: #1e1e1e;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5), 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        /* The main record button */
        #recordButton {
            width: 120px;
            height: 120px;
            border-radius: 50%; /* Starts as a circle */
            background-color: #ff4757; /* A vibrant red */
            border: none;
            cursor: pointer;
            outline: none;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Bouncy transition */
            position: relative;
            box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7);
        }

        /* Style for when recording is active */
        #recordButton.recording {
            animation: pulse-red 1.5s infinite;
            background-color: #2ed573; /* Changes to green */
            border-radius: 30px; /* Becomes a rounded square */
            transform: rotate(45deg); /* Rotates for a diamond shape */
        }
        
        #recordButton.recording::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 4px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg); /* Counter-rotate the inner square */
        }


        /* Pulse animation for the button */
        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(46, 213, 115, 0.5);
            }
            70% {
                box-shadow: 0 0 0 25px rgba(46, 213, 115, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(46, 213, 115, 0);
            }
        }

        /* Timer display */
        #timer {
            margin-top: 40px;
            font-size: 3em;
            color: #f0f0f0;
            font-weight: 700;
            letter-spacing: 2px;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        #timer.visible {
            opacity: 1;
        }

        /* Download link style */
        #downloadLink {
            display: none; /* Initially hidden */
            margin-top: 30px;
            padding: 15px 30px;
            background-color: #3B3B98; /* A nice blue */
            color: white;
            text-decoration: none;
            border-radius: 10px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-size: 1.1em;
            font-weight: bold;
        }

        #downloadLink:hover {
            background-color: #4747B6;
            transform: translateY(-2px);
        }
        
        #status {
            margin-top: 20px;
            color: #aaa;
            height: 20px; /* Reserve space to prevent layout shift */
        }
    </style>
</head>
<body>

<div class="app-container">
    <button id="recordButton" title="Starta Inspelning"></button>
    <div id="status">Klicka för att börja spela in</div>
    <div id="timer">00:00</div>
    <a id="downloadLink">Ladda ner MP3</a>
</div>

<!-- LameJS library for MP3 encoding -->
<script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const recordButton = document.getElementById('recordButton');
        const timerDisplay = document.getElementById('timer');
        const downloadLink = document.getElementById('downloadLink');
        const statusDisplay = document.getElementById('status');

        let isRecording = false;
        let mediaRecorder;
        let audioChunks = [];
        let timerInterval;
        let seconds = 0;
        let audioContext;

        // --- Event Listeners ---
        recordButton.addEventListener('click', toggleRecording);

        // --- Core Functions ---
        async function toggleRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                stopRecording();
            }
        }

        async function startRecording() {
            try {
                // Get microphone access
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Reset from previous recordings
                audioChunks = [];
                downloadLink.style.display = 'none';

                // --- Web Audio API for Automatic Gain Control ---
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(stream);

                // Create a DynamicsCompressor node to level the audio
                const compressor = audioContext.createDynamicsCompressor();
                compressor.threshold.setValueAtTime(-50, audioContext.currentTime); // Start compressing at -50dB
                compressor.knee.setValueAtTime(40, audioContext.currentTime);     // Smooth transition
                compressor.ratio.setValueAtTime(12, audioContext.currentTime);    // 12:1 compression ratio
                compressor.attack.setValueAtTime(0, audioContext.currentTime);    // Instant attack
                compressor.release.setValueAtTime(0.25, audioContext.currentTime);// Quick release

                // Create a destination for the processed audio stream
                const destination = audioContext.createMediaStreamDestination();

                // Connect the nodes: source -> compressor -> destination
                source.connect(compressor);
                compressor.connect(destination);

                // Create MediaRecorder with the processed stream
                mediaRecorder = new MediaRecorder(destination.stream);

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    statusDisplay.textContent = 'Bearbetar...';
                    encodeToMp3();
                };

                mediaRecorder.start();
                
                // Update UI for recording state
                isRecording = true;
                recordButton.classList.add('recording');
                recordButton.title = "Stoppa Inspelning";
                timerDisplay.classList.add('visible');
                statusDisplay.textContent = 'Inspelning pågår...';
                startTimer();

            } catch (err) {
                console.error("Could not start recording:", err);
                statusDisplay.textContent = 'Mikrofonåtkomst nekades.';
                alert("Kunde inte komma åt mikrofonen. Vänligen ge tillåtelse och försök igen.");
            }
        }

        function stopRecording() {
            if (mediaRecorder) {
                mediaRecorder.stop(); // This will trigger the 'onstop' event
                isRecording = false;

                // Update UI for stopped state
                recordButton.classList.remove('recording');
                recordButton.title = "Starta Inspelning";
                stopTimer();
            }
        }
        
        function encodeToMp3() {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const reader = new FileReader();

            reader.onload = function(event) {
                // Decode the audio data from the blob
                audioContext.decodeAudioData(event.target.result)
                    .then(decodedBuffer => {
                        const mp3encoder = new lamejs.Mp3Encoder(1, decodedBuffer.sampleRate, 128); // Mono, 128kbps
                        
                        // Get raw audio samples
                        const samples = decodedBuffer.getChannelData(0);
                        const int16Samples = new Int16Array(samples.length);
                        for (let i = 0; i < samples.length; i++) {
                            int16Samples[i] = samples[i] * 32767.5; // Convert to 16-bit PCM
                        }

                        let mp3Data = [];
                        const sampleBlockSize = 1152; // Standard block size for MP3 encoding

                        for (let i = 0; i < int16Samples.length; i += sampleBlockSize) {
                            const sampleChunk = int16Samples.subarray(i, i + sampleBlockSize);
                            const mp3buf = mp3encoder.encodeBuffer(sampleChunk);
                            if (mp3buf.length > 0) {
                                mp3Data.push(mp3buf);
                            }
                        }
                        
                        // Get the final buffer
                        const mp3buf = mp3encoder.flush();
                        if (mp3buf.length > 0) {
                            mp3Data.push(mp3buf);
                        }

                        // Create the final MP3 blob
                        const mp3Blob = new Blob(mp3Data, { type: 'audio/mp3' });
                        const mp3Url = URL.createObjectURL(mp3Blob);

                        // Update the download link
                        downloadLink.href = mp3Url;
                        downloadLink.download = `inspelning-${new Date().toISOString().slice(0,19).replace('T', '_').replace(/:/g, '-')}.mp3`;
                        downloadLink.style.display = 'block';
                        statusDisplay.textContent = 'Inspelning klar! Ladda ner din fil.';
                    });
            };

            reader.readAsArrayBuffer(audioBlob);
        }

        // --- Timer Utility Functions ---
        function startTimer() {
            seconds = 0;
            timerDisplay.textContent = '00:00';
            timerInterval = setInterval(() => {
                seconds++;
                const minutes = Math.floor(seconds / 60).toString().padStart(2, '0');
                const secs = (seconds % 60).toString().padStart(2, '0');
                timerDisplay.textContent = `${minutes}:${secs}`;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }
    });
</script>

</body>
</html>
